name: CI + Deploy to TrueNAS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: truenas-deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
      TRUENAS_USER: ${{ secrets.TRUENAS_USER }}
      TRUENAS_PORT: ${{ secrets.TRUENAS_SSH_PORT }}
      TRUENAS_APP_PATH: ${{ secrets.TRUENAS_APP_PATH }}
      TRUENAS_SSH_KEY: ${{ secrets.TRUENAS_SSH_KEY }}
    steps:
      - name: Validate secrets
        run: |
          set -euo pipefail
          [ -n "${TRUENAS_HOST:-}" ] || { echo "Missing secret: TRUENAS_HOST"; exit 1; }
          [ -n "${TRUENAS_USER:-}" ] || { echo "Missing secret: TRUENAS_USER"; exit 1; }
          [ -n "${TRUENAS_SSH_KEY:-}" ] || { echo "Missing secret: TRUENAS_SSH_KEY"; exit 1; }

      - name: Configure SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$TRUENAS_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          PORT="${TRUENAS_PORT:-22}"
          ssh-keyscan -p "$PORT" -H "$TRUENAS_HOST" >> ~/.ssh/known_hosts

      - name: Deploy on TrueNAS
        run: |
          set -euo pipefail
          PORT="${TRUENAS_PORT:-22}"
          APP_PATH="${TRUENAS_APP_PATH:-/mnt/Storage_Pool/penthouse/app}"
          ssh -p "$PORT" "${TRUENAS_USER}@${TRUENAS_HOST}" "set -euo pipefail; cd '$APP_PATH'; git fetch --all --prune; git checkout main; git pull --ff-only origin main; docker compose up -d --build; docker compose ps; docker run --rm --network app_default curlimages/curl:8.10.1 -fsS http://penthouse-app:3000/api/health >/dev/null; echo deploy_ok"

name: CI + Deploy to TrueNAS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: truenas-deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: [self-hosted, truenas, penthouse]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy on TrueNAS host
        run: |
          set -euo pipefail
          APP_PATH="/mnt/Storage_Pool/penthouse/app"
          cd "$APP_PATH"
          git fetch --all --prune
          git checkout main
          git reset --hard origin/main
          ./scripts/prepare_data_dirs.sh
          # Build while the old container is still running, then recreate only the app.
          docker compose build penthouse-app
          docker compose up -d --no-deps --force-recreate penthouse-app
          # Apply any compose-level changes to caddy (logging, ports, etc.) without forcing a restart every deploy.
          docker compose up -d caddy
          # Apply Caddyfile changes without restarting Caddy.
          docker compose exec -T caddy caddy reload --config /etc/caddy/Caddyfile || true
          docker compose ps
          # Wait for health (handles brief restart window).
          for i in $(seq 1 30); do
            if docker compose exec -T penthouse-app wget -q --spider http://localhost:3000/api/health; then
              echo health_ok
              break
            fi
            sleep 2
          done
          docker compose exec -T penthouse-app wget -q --spider http://localhost:3000/api/health
          echo deploy_ok

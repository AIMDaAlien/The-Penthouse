name: CI + Deploy to TrueNAS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_apk_build:
        description: Force a new Android APK build (uses EAS build quota)
        type: boolean
        required: false
        default: false

concurrency:
  group: truenas-deploy-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      apk_built: ${{ steps.build_apk.outputs.apk_built || 'false' }}
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide whether APK build is required
        id: build_gate
        run: |
          set -euo pipefail
          SHOULD_BUILD="false"
          NATIVE_CHANGED="false"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_apk_build }}" = "true" ]; then
            SHOULD_BUILD="true"
            NATIVE_CHANGED="true"
          elif [ "${{ github.event_name }}" = "push" ]; then
            BEFORE_SHA="${{ github.event.before }}"
            if [ -z "${BEFORE_SHA}" ] || [ "${BEFORE_SHA}" = "0000000000000000000000000000000000000000" ]; then
              SHOULD_BUILD="true"
              NATIVE_CHANGED="true"
            elif [ -n "${BEFORE_SHA}" ] && [ "${BEFORE_SHA}" != "0000000000000000000000000000000000000000" ]; then
              CHANGED_FILES="$(git diff --name-only "${BEFORE_SHA}" "${{ github.sha }}")"
              if echo "${CHANGED_FILES}" | grep -Eq '^mobile/(android/|ios/|app\.json$|app\.config\.(js|ts|json)$|eas\.json$|package\.json$|package-lock\.json$|plugins/)'; then
                NATIVE_CHANGED="true"
                SHOULD_BUILD="true"
              fi
            fi
          fi

          echo "should_build=${SHOULD_BUILD}" >> "${GITHUB_OUTPUT}"
          echo "native_changed=${NATIVE_CHANGED}" >> "${GITHUB_OUTPUT}"
          echo "APK build required: ${SHOULD_BUILD}"
          echo "Native-impact change detected: ${NATIVE_CHANGED}"

      - name: Validate Expo token
        if: steps.build_gate.outputs.should_build == 'true'
        run: |
          if [ -z "${EXPO_TOKEN}" ]; then
            echo "EXPO_TOKEN secret is required to build Android APK via EAS."
            exit 1
          fi

      - name: Set up Node.js
        if: steps.build_gate.outputs.should_build == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: mobile/package-lock.json

      - name: Install mobile dependencies
        if: steps.build_gate.outputs.should_build == 'true'
        run: npm ci --prefix mobile

      - name: Generate release notes
        if: steps.build_gate.outputs.should_build == 'true'
        run: |
          set -euo pipefail
          mkdir -p artifacts
          ./scripts/generate_release_notes.sh "${{ github.event.before }}" "${{ github.sha }}" > artifacts/release-notes.txt
          echo "Release notes:"
          cat artifacts/release-notes.txt

      - name: Validate mobile version semantics
        if: steps.build_gate.outputs.should_build == 'true'
        run: |
          set -euo pipefail
          APP_VERSION="$(jq -r '.expo.version // empty' mobile/app.json)"
          PKG_VERSION="$(jq -r '.version // empty' mobile/package.json)"
          if [ -z "${APP_VERSION}" ] || [ -z "${PKG_VERSION}" ]; then
            echo "mobile/app.json expo.version and mobile/package.json version are required."
            exit 1
          fi
          if [ "${APP_VERSION}" != "${PKG_VERSION}" ]; then
            echo "Version mismatch: app.json=${APP_VERSION}, package.json=${PKG_VERSION}"
            exit 1
          fi
          if ! [[ "${APP_VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must be SemVer (x.y.z). Got: ${APP_VERSION}"
            exit 1
          fi

      - name: Resolve release version
        id: version
        if: steps.build_gate.outputs.should_build == 'true'
        run: |
          set -euo pipefail
          APP_VERSION="$(jq -r '.expo.version // empty' mobile/app.json)"
          if [ -z "${APP_VERSION}" ]; then
            echo "Could not resolve expo.version from mobile/app.json"
            exit 1
          fi
          echo "app_version=${APP_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "release_tag=v${APP_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "release_name=The Penthouse v${APP_VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Build Android APK with EAS
        id: build_apk
        if: steps.build_gate.outputs.should_build == 'true'
        run: |
          set -euo pipefail
          cd mobile
          BUILD_OUTPUT_PATH="${RUNNER_TEMP}/eas-build-output.txt"
          BUILD_VIEW_JSON_PATH="${RUNNER_TEMP}/eas-build-view.json"
          set +e
          npx eas-cli@latest build --platform android --profile preview --non-interactive --wait --json > "${BUILD_OUTPUT_PATH}" 2>&1
          BUILD_EXIT=$?
          set -e

          if [ "${BUILD_EXIT}" -ne 0 ]; then
            if grep -qi "has used its Android builds from the Free plan this month" "${BUILD_OUTPUT_PATH}"; then
              if [ "${{ steps.build_gate.outputs.native_changed }}" = "true" ]; then
                echo "EAS Android build quota exhausted, but native-impact changes require a fresh APK build."
                cat "${BUILD_OUTPUT_PATH}"
                exit "${BUILD_EXIT}"
              fi
              echo "EAS Android build quota exhausted. Skipping APK rebuild for this run."
              echo "apk_built=false" >> "${GITHUB_OUTPUT}"
              exit 0
            fi

            echo "EAS build failed unexpectedly:"
            cat "${BUILD_OUTPUT_PATH}"
            exit "${BUILD_EXIT}"
          fi

          APK_URL="$(node -e 'const fs=require("fs");const raw=fs.readFileSync(process.argv[1],"utf8").trim();let parsed;try{parsed=JSON.parse(raw);}catch(_){const line=raw.split("\\n").reverse().find(l=>l.trim().startsWith("{")||l.trim().startsWith("["));if(!line){process.exit(2);}parsed=JSON.parse(line);}const builds=Array.isArray(parsed)?parsed:[parsed];const build=builds.find(item=>item&&item.artifacts&&(item.artifacts.buildUrl||item.artifacts.applicationArchiveUrl));const apkUrl=build&&build.artifacts&&(build.artifacts.buildUrl||build.artifacts.applicationArchiveUrl);if(!apkUrl){process.exit(3);}process.stdout.write(apkUrl);' "${BUILD_OUTPUT_PATH}" 2>/dev/null || true)"
          if [ -z "${APK_URL}" ]; then
            BUILD_ID="$(grep -Eo 'builds/[0-9a-fA-F-]{36}' "${BUILD_OUTPUT_PATH}" | tail -n1 | cut -d/ -f2 || true)"
            if [ -n "${BUILD_ID}" ]; then
              npx eas-cli@latest build:view "${BUILD_ID}" --json > "${BUILD_VIEW_JSON_PATH}"
              APK_URL="$(node -e 'const fs=require("fs");const parsed=JSON.parse(fs.readFileSync(process.argv[1],"utf8"));const apkUrl=parsed&&parsed.artifacts&&(parsed.artifacts.buildUrl||parsed.artifacts.applicationArchiveUrl);if(!apkUrl){process.exit(1);}process.stdout.write(apkUrl);' "${BUILD_VIEW_JSON_PATH}" 2>/dev/null || true)"
            fi
          fi
          if [ -z "${APK_URL}" ]; then
            echo "Unable to resolve APK URL from EAS output."
            cat "${BUILD_OUTPUT_PATH}"
            if [ -f "${BUILD_VIEW_JSON_PATH}" ]; then
              cat "${BUILD_VIEW_JSON_PATH}"
            fi
            exit 1
          fi
          cd "${GITHUB_WORKSPACE}"
          mkdir -p artifacts
          curl -fL "${APK_URL}" -o artifacts/the-penthouse.apk
          ls -lh artifacts/the-penthouse.apk
          echo "apk_built=true" >> "${GITHUB_OUTPUT}"

      - name: Mark APK as not built (no mobile changes)
        if: steps.build_gate.outputs.should_build != 'true'
        run: echo "APK build skipped because no mobile changes were detected."

      - name: Compute APK checksum
        id: checksum
        if: steps.build_apk.outputs.apk_built == 'true'
        run: |
          set -euo pipefail
          APK_SHA256="$(sha256sum artifacts/the-penthouse.apk | awk '{print $1}')"
          echo "sha256=${APK_SHA256}" >> "${GITHUB_OUTPUT}"

      - name: Build GitHub release body
        if: steps.build_apk.outputs.apk_built == 'true'
        env:
          APP_VERSION: ${{ steps.version.outputs.app_version }}
          APK_SHA256: ${{ steps.checksum.outputs.sha256 }}
        run: |
          set -euo pipefail
          {
            echo "## release"
            echo "- app version: ${APP_VERSION}"
            echo "- commit: ${GITHUB_SHA}"
            echo "- apk sha256: \`${APK_SHA256}\`"
            echo
            cat artifacts/release-notes.txt
            echo
            echo "## install / downgrade"
            echo "- Latest APK: https://penthouse.blog/downloads/the-penthouse.apk"
            echo "- Older APKs: use assets attached in previous GitHub Releases."
          } > artifacts/github-release-notes.md

      - name: Publish GitHub release
        if: steps.build_apk.outputs.apk_built == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.release_tag }}
          name: ${{ steps.version.outputs.release_name }}
          body_path: artifacts/github-release-notes.md
          files: |
            artifacts/the-penthouse.apk
            artifacts/release-notes.txt
          draft: false
          prerelease: false
          overwrite_files: true
          make_latest: true

      - name: Upload APK artifact
        if: steps.build_apk.outputs.apk_built == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: penthouse-android-apk
          path: |
            artifacts/the-penthouse.apk
            artifacts/release-notes.txt
          if-no-files-found: error
          retention-days: 7

  deploy:
    needs: build-apk
    runs-on: [self-hosted, truenas, penthouse]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download APK artifact
        if: needs.build-apk.outputs.apk_built == 'true'
        uses: actions/download-artifact@v4
        with:
          name: penthouse-android-apk
          path: ${{ github.workspace }}/apk-release

      - name: Deploy on TrueNAS host
        run: |
          set -euo pipefail
          APP_PATH="/mnt/Storage_Pool/penthouse/app"
          DEFAULT_DATA_PATH="/mnt/Storage_Pool/penthouse/data"
          FALLBACK_DATA_PATH="${APP_PATH}/data"
          DATA_PATH="${DEFAULT_DATA_PATH}"

          can_use_data_path() {
            local candidate="$1"
            mkdir -p "${candidate}" 2>/dev/null || return 1
            mkdir -p "${candidate}/uploads" "${candidate}/downloads" 2>/dev/null || return 1
            return 0
          }

          if ! can_use_data_path "${DATA_PATH}"; then
            echo "Warning: ${DATA_PATH} is not writable for uploads/downloads; falling back to ${FALLBACK_DATA_PATH}"
            DATA_PATH="${FALLBACK_DATA_PATH}"
          fi
          if ! can_use_data_path "${DATA_PATH}"; then
            echo "Error: unable to create data directory at ${DATA_PATH}"
            exit 1
          fi
          export PENTHOUSE_DATA_PATH="${DATA_PATH}"
          APK_PATH="${GITHUB_WORKSPACE}/apk-release/the-penthouse.apk"
          NOTES_PATH="${GITHUB_WORKSPACE}/apk-release/release-notes.txt"
          cd "$APP_PATH"
          git fetch --all --prune
          git checkout main
          git reset --hard origin/main
          ./scripts/prepare_data_dirs.sh
          USE_SUDO_DOCKER="false"
          if ! docker info >/dev/null 2>&1; then
            if sudo -n docker info >/dev/null 2>&1; then
              USE_SUDO_DOCKER="true"
              echo "Docker requires sudo on this runner; using sudo -n docker compose"
            else
              echo "Error: runner user cannot access Docker socket, and sudo -n docker is unavailable."
              echo "Fix host permissions: add runner user to docker group or allow passwordless sudo for docker."
              exit 1
            fi
          fi
          dc() {
            if [ "${USE_SUDO_DOCKER}" = "true" ]; then
              sudo -n docker compose "$@"
            else
              docker compose "$@"
            fi
          }
          if [ -s "${APK_PATH}" ]; then
            if [ -s "${NOTES_PATH}" ]; then
              MOBILE_UPDATE_NOTES_FILE="${NOTES_PATH}" ./scripts/publish_apk.sh "${APK_PATH}"
            else
              ./scripts/publish_apk.sh "${APK_PATH}"
            fi
          else
            echo "No new APK artifact for this run; keeping current published APK."
          fi
          # Build while the old container is still running, then recreate only the app.
          dc build penthouse-app
          dc up -d --no-deps --force-recreate penthouse-app
          # Apply any compose-level changes to caddy without re-evaluating app health dependencies.
          dc up -d --no-deps caddy
          # Apply Caddyfile changes without restarting Caddy.
          dc exec -T caddy caddy reload --config /etc/caddy/Caddyfile || true
          dc ps
          # Wait for health (handles brief restart window).
          for i in $(seq 1 30); do
            if dc exec -T penthouse-app wget -q --spider http://localhost:3000/api/health; then
              echo health_ok
              break
            fi
            sleep 2
          done
          dc exec -T penthouse-app wget -q --spider http://localhost:3000/api/health || {
            echo "penthouse-app health check failed; recent logs:"
            dc logs --tail=200 penthouse-app || true
            exit 1
          }
          dc exec -T penthouse-app wget -q --spider http://localhost:3000/app/ || {
            echo "Web app route check failed (/app). Recent logs:"
            dc logs --tail=200 penthouse-app || true
            exit 1
          }
          dc exec -T penthouse-app wget -q --spider http://localhost:3000/app/metadata.json || {
            echo "Web app artifact missing (/app/metadata.json). Recent logs:"
            dc logs --tail=200 penthouse-app || true
            exit 1
          }
          dc exec -T penthouse-app wget -q --spider http://localhost:3000/downloads/the-penthouse.apk
          echo deploy_ok

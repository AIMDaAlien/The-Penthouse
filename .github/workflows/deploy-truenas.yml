name: CI + Deploy to TrueNAS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: truenas-deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: [self-hosted, truenas, penthouse]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy on TrueNAS host
        run: |
          set -euo pipefail
          APP_PATH="/mnt/Storage_Pool/penthouse/app"
          cd "$APP_PATH"
          git fetch --all --prune
          git checkout main
          git reset --hard origin/main
          ./scripts/prepare_data_dirs.sh
          docker compose up -d --build
          docker compose ps
          docker compose exec -T penthouse-app wget -q --spider http://localhost:3000/api/health
          echo deploy_ok
